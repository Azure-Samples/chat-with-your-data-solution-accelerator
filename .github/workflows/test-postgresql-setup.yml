name: Test PostgreSQL Setup

on:
  workflow_dispatch:
    inputs:
      RESOURCE_GROUP_NAME:
        description: 'Azure Resource Group name'
        required: true
        type: string
      AZURE_POSTGRESQL_HOST_NAME:
        description: 'PostgreSQL host name (e.g., myserver.postgres.database.azure.com)'
        required: true
        type: string

jobs:
  test-postgresql-setup:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Login to Azure
        shell: bash
        run: |
          az login --service-principal -u ${{ secrets.AZURE_CLIENT_ID }} -p ${{ secrets.AZURE_CLIENT_SECRET }} --tenant ${{ secrets.AZURE_TENANT_ID }}
          az account set --subscription ${{ secrets.AZURE_SUBSCRIPTION_ID }}

      - name: Upgrade Azure CLI and install extensions
        run: |
          az upgrade --yes --all
          az extension add --name rdbms-connect --upgrade --yes || true

      - name: Install Python dependencies
        run: |
          pip install psycopg2-binary python-dotenv azure-identity

      - name: Add Service Principal as PostgreSQL Admin
        run: |
          # Get PostgreSQL server name from input parameter
          PG_HOST="${{ inputs.AZURE_POSTGRESQL_HOST_NAME }}"
          PG_SERVER_NAME=$(echo $PG_HOST | cut -d'.' -f1)

          # Get the service principal's object ID (required for PostgreSQL admin)
          SP_OBJECT_ID=$(az ad sp show --id ${{ secrets.AZURE_CLIENT_ID }} --query id -o tsv)

          # Get service principal display name
          SP_DISPLAY_NAME=$(az ad sp show --id ${{ secrets.AZURE_CLIENT_ID }} --query displayName -o tsv)

          # Export display name for use in subsequent steps
          echo "SP_DISPLAY_NAME=$SP_DISPLAY_NAME" >> $GITHUB_ENV

          echo "PostgreSQL Host: $PG_HOST"
          echo "PostgreSQL Server Name: $PG_SERVER_NAME"
          echo "Service Principal Object ID: $SP_OBJECT_ID"
          echo "Service Principal Display Name: $SP_DISPLAY_NAME"

          echo "Adding service principal '$SP_DISPLAY_NAME' (Object ID: $SP_OBJECT_ID) as PostgreSQL admin..."

          # Add service principal as Entra ID administrator using REST API
          az rest --method PUT \
            --uri "https://management.azure.com/subscriptions/${{ secrets.AZURE_SUBSCRIPTION_ID }}/resourceGroups/${{ inputs.RESOURCE_GROUP_NAME }}/providers/Microsoft.DBforPostgreSQL/flexibleServers/${PG_SERVER_NAME}/administrators/${SP_OBJECT_ID}?api-version=2022-12-01" \
            --body "{\"properties\": {\"principalType\": \"ServicePrincipal\", \"principalName\": \"${SP_DISPLAY_NAME}\", \"tenantId\": \"${{ secrets.AZURE_TENANT_ID }}\"}}" \
            || echo "Admin may already exist, continuing..."

          echo "âœ… Service principal configured as PostgreSQL administrator"

      - name: Populate PostgreSQL Database
        run: |
          export PG_HOST_DESTINATION="${{ inputs.AZURE_POSTGRESQL_HOST_NAME }}"
          # Get the service principal's display name (required as username for PostgreSQL Entra auth)
          export SP_DISPLAY_NAME=$(az ad sp show --id ${{ secrets.AZURE_CLIENT_ID }} --query displayName -o tsv)

          echo "Connecting to PostgreSQL at: $PG_HOST_DESTINATION"
          echo "Using service principal: $SP_DISPLAY_NAME"

          python - <<EOF
          import os
          import psycopg2
          from azure.identity import ClientSecretCredential

          tenant_id = os.environ["AZURE_TENANT_ID"]
          client_id = os.environ["AZURE_CLIENT_ID"]
          client_secret = os.environ["AZURE_CLIENT_SECRET"]
          pg_host = os.environ.get("PG_HOST_DESTINATION")
          sp_display_name = os.environ.get("SP_DISPLAY_NAME")

          print(f"Tenant ID: {tenant_id}")
          print(f"Client ID: {client_id}")
          print(f"PostgreSQL Host: {pg_host}")
          print(f"Service Principal Name: {sp_display_name}")

          # Acquire Azure AD access token for PostgreSQL
          credential = ClientSecretCredential(tenant_id, client_id, client_secret)
          token = credential.get_token("https://ossrdbms-aad.database.windows.net/.default").token
          print("âœ… Successfully acquired Azure AD token")

          db_params = {
              "user": sp_display_name,   # Use service principal display name (must match PostgreSQL admin name)
              "password": token,          # Use AAD token
              "host": pg_host,
              "port": "5432",
              "dbname": "postgres",
              "sslmode": "require"
          }

          csv_file = "exported_data_vector_score.csv"
          target_table = "vector_store"

          try:
              print(f"Connecting to PostgreSQL database...")
              with psycopg2.connect(**db_params) as conn:
                  print("âœ… Connected to PostgreSQL")
                  with conn.cursor() as cur:
                      # Check if table exists
                      cur.execute(f"SELECT EXISTS (SELECT FROM information_schema.tables WHERE table_name = '{target_table}');")
                      table_exists = cur.fetchone()[0]
                      print(f"Table '{target_table}' exists: {table_exists}")

                      if not table_exists:
                          print(f"âš ï¸ Table '{target_table}' does not exist. Skipping data import.")
                      else:
                          with open(csv_file, "r", encoding="utf-8") as f:
                              next(f)  # Skip header
                              cur.copy_expert(f"COPY {target_table} FROM STDIN WITH CSV", f)
                          conn.commit()
                          print(f"âœ… Imported data from '{csv_file}' into table '{target_table}'.")
          except FileNotFoundError:
              print(f"âš ï¸ CSV file '{csv_file}' not found. Skipping data import.")
          except Exception as e:
              print(f"âŒ Error during import: {e}")
              raise
          EOF
        env:
          AZURE_CLIENT_ID: ${{ secrets.AZURE_CLIENT_ID }}
          AZURE_CLIENT_SECRET: ${{ secrets.AZURE_CLIENT_SECRET }}
          AZURE_TENANT_ID: ${{ secrets.AZURE_TENANT_ID }}
          SP_DISPLAY_NAME: ${{ env.SP_DISPLAY_NAME }}

      - name: Generate Test Job Summary
        if: always()
        run: |
          echo "## ðŸ§ª PostgreSQL Setup Test Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Field | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| **Job Status** | ${{ job.status == 'success' && 'âœ… Success' || 'âŒ Failed' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| **PostgreSQL Host** | \`${{ inputs.AZURE_POSTGRESQL_HOST_NAME }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| **Resource Group** | \`${{ inputs.RESOURCE_GROUP_NAME }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [[ "${{ job.status }}" == "success" ]]; then
            echo "### âœ… Test Results" >> $GITHUB_STEP_SUMMARY
            echo "- Service principal successfully added as PostgreSQL admin" >> $GITHUB_STEP_SUMMARY
            echo "- PostgreSQL database connection verified" >> $GITHUB_STEP_SUMMARY
            echo "- Data import completed successfully" >> $GITHUB_STEP_SUMMARY
          else
            echo "### âŒ Test Failed" >> $GITHUB_STEP_SUMMARY
            echo "- Check the job logs for detailed error information" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Logout from Azure
        if: always()
        shell: bash
        run: |
          az logout || true
          echo "Logged out from Azure."
