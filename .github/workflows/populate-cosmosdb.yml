name: Test CosmosDB Setup

on:
  workflow_dispatch:
    inputs:
      RESOURCE_GROUP_NAME:
        description: 'Azure Resource Group name'
        required: true
        type: string
      AZURE_SEARCH_SERVICE:
        description: 'Azure Search service name or URL'
        required: true
        type: string
      AZURE_BLOB_ACCOUNT_NAME:
        description: 'Azure Blob Storage Account name'
        required: true
        type: string
      AZURE_SEARCH_INDEX:
        description: 'Azure Search index name'
        required: true
        type: string
      WAF:
        description: 'Enable WAF mode (enables public access and allows all IPs for Azure Search)'
        required: false
        type: boolean
        default: false
  workflow_call:
    inputs:
      RESOURCE_GROUP_NAME:
        description: 'Azure Resource Group name'
        required: true
        type: string
      AZURE_SEARCH_SERVICE:
        description: 'Azure Search service name or URL'
        required: true
        type: string
      AZURE_BLOB_ACCOUNT_NAME:
        description: 'Azure Blob Storage Account name'
        required: true
        type: string
      AZURE_SEARCH_INDEX:
        description: 'Azure Search index name'
        required: true
        type: string
      WAF:
        description: 'Enable WAF mode (enables public access and allows all IPs for Azure Search)'
        required: false
        type: boolean
        default: false

jobs:
  test-cosmosdb-setup:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Login to Azure
        shell: bash
        run: |
          az login --service-principal -u ${{ secrets.AZURE_CLIENT_ID }} -p ${{ secrets.AZURE_CLIENT_SECRET }} --tenant ${{ secrets.AZURE_TENANT_ID }}
          az account set --subscription ${{ secrets.AZURE_SUBSCRIPTION_ID }}

      - name: Upgrade Azure CLI and install extensions
        run: |
          az upgrade --yes --all
          az extension add --name storage-preview --upgrade --yes || true

      - name: Extract Service Names
        id: extract_names
        run: |
          # Extract Azure Search service name if full URL is provided
          AZURE_SEARCH_SERVICE_INPUT="${{ inputs.AZURE_SEARCH_SERVICE }}"
          if [[ "$AZURE_SEARCH_SERVICE_INPUT" == https://* ]]; then
            AZURE_SEARCH_SERVICE=$(echo "$AZURE_SEARCH_SERVICE_INPUT" | sed 's|https://||' | cut -d'.' -f1)
          else
            AZURE_SEARCH_SERVICE="$AZURE_SEARCH_SERVICE_INPUT"
          fi
          echo "AZURE_SEARCH_SERVICE=$AZURE_SEARCH_SERVICE" >> $GITHUB_OUTPUT
          echo "Using Azure Search Service: $AZURE_SEARCH_SERVICE"

          # Extract Azure Blob Storage Account name if full URL is provided
          AZURE_BLOB_ACCOUNT_NAME_INPUT="${{ inputs.AZURE_BLOB_ACCOUNT_NAME }}"
          if [[ "$AZURE_BLOB_ACCOUNT_NAME_INPUT" == https://* ]]; then
            AZURE_BLOB_ACCOUNT_NAME=$(echo "$AZURE_BLOB_ACCOUNT_NAME_INPUT" | sed 's|https://||' | cut -d'.' -f1)
          else
            AZURE_BLOB_ACCOUNT_NAME="$AZURE_BLOB_ACCOUNT_NAME_INPUT"
          fi
          echo "AZURE_BLOB_ACCOUNT_NAME=$AZURE_BLOB_ACCOUNT_NAME" >> $GITHUB_OUTPUT
          echo "Using Azure Blob Storage Account: $AZURE_BLOB_ACCOUNT_NAME"

      - name: Enable Public Access for Azure Search (WAF Mode)
        if: ${{ inputs.WAF == true }}
        run: |
          AZURE_SEARCH_SERVICE="${{ steps.extract_names.outputs.AZURE_SEARCH_SERVICE }}"
          RESOURCE_GROUP="${{ inputs.RESOURCE_GROUP_NAME }}"

          echo "WAF mode enabled - Configuring public access for Azure Search service: $AZURE_SEARCH_SERVICE"

          # Get the current identity configuration to preserve it during update
          echo "Getting current identity configuration..."
          IDENTITY_TYPE=$(az search service show \
            --name "$AZURE_SEARCH_SERVICE" \
            --resource-group "$RESOURCE_GROUP" \
            --query "identity.type" -o tsv 2>/dev/null || echo "None")

          echo "Current identity type: $IDENTITY_TYPE"

          # Enable public network access for Azure Search
          echo "Enabling public network access..."

          # Check if identity type contains UserAssigned (handles "UserAssigned", "SystemAssigned, UserAssigned", etc.)
          if [[ "$IDENTITY_TYPE" == *"UserAssigned"* ]]; then
            # Get the user-assigned identity IDs
            IDENTITY_IDS=$(az search service show \
              --name "$AZURE_SEARCH_SERVICE" \
              --resource-group "$RESOURCE_GROUP" \
              --query "identity.userAssignedIdentities | keys(@) | join(',', @)" -o tsv)

            echo "User-assigned identity IDs: $IDENTITY_IDS"

            az search service update \
              --name "$AZURE_SEARCH_SERVICE" \
              --resource-group "$RESOURCE_GROUP" \
              --public-access enabled \
              --identity-type "$IDENTITY_TYPE" \
              --user-assigned-ids $IDENTITY_IDS
          else
            az search service update \
              --name "$AZURE_SEARCH_SERVICE" \
              --resource-group "$RESOURCE_GROUP" \
              --public-access enabled
          fi

          echo "‚úÖ Public access enabled and all IP addresses allowed for Azure Search service"

      - name: Enable Public Access for Storage Account (WAF Mode)
        if: ${{ inputs.WAF == true }}
        run: |
          AZURE_BLOB_ACCOUNT_NAME="${{ steps.extract_names.outputs.AZURE_BLOB_ACCOUNT_NAME }}"
          RESOURCE_GROUP="${{ inputs.RESOURCE_GROUP_NAME }}"

          echo "WAF mode enabled - Configuring public access for Storage Account: $AZURE_BLOB_ACCOUNT_NAME"

          # Get original Storage Account public access status
          original_storage_public_access=$(az storage account show \
            --name "$AZURE_BLOB_ACCOUNT_NAME" \
            --resource-group "$RESOURCE_GROUP" \
            --query "publicNetworkAccess" \
            -o tsv 2>&1)
          if [ -z "$original_storage_public_access" ] || [[ "$original_storage_public_access" == *"ERROR"* ]]; then
            echo "‚úó Failed to get Storage Account public access status"
            exit 1
          fi
          echo "Original Storage Account public access: $original_storage_public_access"

          # Get original Storage Account network default action
          original_storage_default_action=$(az storage account show \
            --name "$AZURE_BLOB_ACCOUNT_NAME" \
            --resource-group "$RESOURCE_GROUP" \
            --query "networkRuleSet.defaultAction" \
            -o tsv 2>&1)
          if [ -z "$original_storage_default_action" ] || [[ "$original_storage_default_action" == *"ERROR"* ]]; then
            echo "‚úó Failed to get Storage Account network default action"
            exit 1
          fi
          echo "Original Storage Account default action: $original_storage_default_action"

          # Save original values for cleanup step
          echo "ORIGINAL_STORAGE_PUBLIC_ACCESS=$original_storage_public_access" >> $GITHUB_ENV
          echo "ORIGINAL_STORAGE_DEFAULT_ACTION=$original_storage_default_action" >> $GITHUB_ENV

          # Enable public access if not already enabled
          if [ "$original_storage_public_access" != "Enabled" ]; then
            echo "‚úì Enabling Storage Account public access"
            az storage account update \
              --name "$AZURE_BLOB_ACCOUNT_NAME" \
              --resource-group "$RESOURCE_GROUP" \
              --public-network-access Enabled \
              --output none
            if [ $? -ne 0 ]; then
              echo "‚úó Failed to enable Storage Account public access"
              exit 1
            fi
          else
            echo "‚úì Storage Account public access already enabled"
          fi

          # Also ensure the default network action allows access
          if [ "$original_storage_default_action" != "Allow" ]; then
            echo "‚úì Setting Storage Account network default action to Allow"
            az storage account update \
              --name "$AZURE_BLOB_ACCOUNT_NAME" \
              --resource-group "$RESOURCE_GROUP" \
              --default-action Allow \
              --output none
            if [ $? -ne 0 ]; then
              echo "‚úó Failed to set Storage Account network default action"
              exit 1
            fi
          else
            echo "‚úì Storage Account network default action already Allow"
          fi

          echo "‚úÖ Public access enabled for Storage Account"

      - name: Install Python dependencies
        run: |
          pip install requests azure-storage-blob azure-identity

      - name: Upload Document to Blob Storage to Trigger Index Creation
        run: |
          AZURE_BLOB_ACCOUNT_NAME="${{ steps.extract_names.outputs.AZURE_BLOB_ACCOUNT_NAME }}"

          echo "Uploading sample document to blob storage to trigger index creation..."

          # Get storage account key for authentication
          STORAGE_KEY=$(az storage account keys list --account-name "$AZURE_BLOB_ACCOUNT_NAME" --resource-group "${{ inputs.RESOURCE_GROUP_NAME }}" --query '[0].value' -o tsv)

          # Upload file using Azure CLI with account key
          az storage blob upload \
            --account-name "$AZURE_BLOB_ACCOUNT_NAME" \
            --account-key "$STORAGE_KEY" \
            --container-name "documents" \
            --name "PerksPlus.pdf" \
            --file "data/PerksPlus.pdf" \
            --overwrite

          echo "‚úÖ Document uploaded to blob storage"

      - name: Wait for Index Creation
        run: |
          AZURE_SEARCH_SERVICE="${{ steps.extract_names.outputs.AZURE_SEARCH_SERVICE }}"
          AZURE_SEARCH_INDEX="${{ inputs.AZURE_SEARCH_INDEX }}"

          # Get Azure Search admin key
          AZURE_SEARCH_KEY=$(az search admin-key show --service-name $AZURE_SEARCH_SERVICE --resource-group ${{ inputs.RESOURCE_GROUP_NAME }} --query primaryKey -o tsv)

          echo "Waiting for index '$AZURE_SEARCH_INDEX' to be created by the application..."
          echo "This may take a few minutes as the document is processed..."

          # Wait up to 10 minutes for the index to be created
          for i in {1..20}; do
            echo "Checking for index (attempt $i/20)..."

            HTTP_STATUS=$(curl -s -o /dev/null -w "%{http_code}" \
              "https://${AZURE_SEARCH_SERVICE}.search.windows.net/indexes/${AZURE_SEARCH_INDEX}?api-version=2024-07-01" \
              -H "api-key: ${AZURE_SEARCH_KEY}")

            if [ "$HTTP_STATUS" == "200" ]; then
              echo "‚úÖ Index '$AZURE_SEARCH_INDEX' found!"
              break
            fi

            if [ $i -eq 20 ]; then
              echo "‚ö†Ô∏è Index not found after 10 minutes, proceeding anyway..."
            else
              echo "Index not found yet (HTTP $HTTP_STATUS), waiting 30 seconds..."
              sleep 30
            fi
          done

      - name: Populate Azure Search Index
        run: |
          AZURE_SEARCH_SERVICE="${{ steps.extract_names.outputs.AZURE_SEARCH_SERVICE }}"
          AZURE_SEARCH_INDEX="${{ inputs.AZURE_SEARCH_INDEX }}"

          export AZURE_SEARCH_SERVICE
          export AZURE_SEARCH_INDEX

          # Get Azure Search admin key from Azure
          export AZURE_SEARCH_KEY=$(az search admin-key show --service-name $AZURE_SEARCH_SERVICE --resource-group ${{ inputs.RESOURCE_GROUP_NAME }} --query primaryKey -o tsv)

          echo "Populating index: $AZURE_SEARCH_INDEX"

          python - <<EOF
          import requests
          import json
          import os

          # Azure Cognitive Search details from environment
          SEARCH_SERVICE = os.environ.get("AZURE_SEARCH_SERVICE")
          INDEX_NAME = os.environ.get("AZURE_SEARCH_INDEX")
          API_KEY = os.environ.get("AZURE_SEARCH_KEY")

          # Use stable API version
          API_VERSION = "2024-07-01"

          # Search API endpoint
          ENDPOINT = f"https://{SEARCH_SERVICE}.search.windows.net/indexes/{INDEX_NAME}/docs/index?api-version={API_VERSION}"
          HEADERS = {
              "Content-Type": "application/json",
              "api-key": API_KEY
          }

          # Load exported data
          with open("data/azure_search_data.json", "r", encoding="utf-8") as f:
              documents = json.load(f)

          # Format for Azure Search bulk upload
          payload = {
              "value": [{"@search.action": "upload", **doc} for doc in documents]
          }

          print(f"Uploading {len(documents)} documents to index '{INDEX_NAME}'...")

          # Send data to Azure Search
          response = requests.post(ENDPOINT, headers=HEADERS, json=payload)

          if response.status_code in [200, 207]:
              result = response.json()
              success_count = sum(1 for item in result.get('value', []) if item.get('status', False))
              print(f"‚úÖ Import completed! {success_count}/{len(documents)} documents uploaded successfully.")
          else:
              print(f"‚ùå Failed to import data: {response.status_code}, {response.text}")
              exit(1)
          EOF

      - name: Disable Public Access for Azure Search (WAF Mode Cleanup)
        if: ${{ inputs.WAF == true }}
        run: |
          AZURE_SEARCH_SERVICE="${{ steps.extract_names.outputs.AZURE_SEARCH_SERVICE }}"

          echo "WAF mode cleanup - Removing public access for Azure Search service: $AZURE_SEARCH_SERVICE"

          # Disable public network access for Azure Search
          echo "Disabling public network access..."
          az search service update \
            --name "$AZURE_SEARCH_SERVICE" \
            --resource-group "${{ inputs.RESOURCE_GROUP_NAME }}" \
            --public-access disabled

          echo "‚úÖ Public access disabled for Azure Search service"

      - name: Disable Public Access for Storage Account (WAF Mode Cleanup)
        if: ${{ inputs.WAF == true }}
        run: |
          AZURE_BLOB_ACCOUNT_NAME="${{ steps.extract_names.outputs.AZURE_BLOB_ACCOUNT_NAME }}"

          echo "WAF mode cleanup - Restoring original public access settings for Storage Account: $AZURE_BLOB_ACCOUNT_NAME"

          # Restore original public network access setting
          if [[ -n "$ORIGINAL_STORAGE_PUBLIC_ACCESS" && "$ORIGINAL_STORAGE_PUBLIC_ACCESS" != "Enabled" ]]; then
            echo "Restoring public network access to: $ORIGINAL_STORAGE_PUBLIC_ACCESS"
            az storage account update \
              --name "$AZURE_BLOB_ACCOUNT_NAME" \
              --resource-group "${{ inputs.RESOURCE_GROUP_NAME }}" \
              --public-network-access "$ORIGINAL_STORAGE_PUBLIC_ACCESS"
            echo "‚úÖ Public network access restored to $ORIGINAL_STORAGE_PUBLIC_ACCESS"
          else
            echo "Public network access was already Enabled, no restore needed"
          fi

          # Restore original default action setting
          if [[ -n "$ORIGINAL_STORAGE_DEFAULT_ACTION" && "$ORIGINAL_STORAGE_DEFAULT_ACTION" != "Allow" ]]; then
            echo "Restoring default action to: $ORIGINAL_STORAGE_DEFAULT_ACTION"
            az storage account update \
              --name "$AZURE_BLOB_ACCOUNT_NAME" \
              --resource-group "${{ inputs.RESOURCE_GROUP_NAME }}" \
              --default-action "$ORIGINAL_STORAGE_DEFAULT_ACTION"
            echo "‚úÖ Default action restored to $ORIGINAL_STORAGE_DEFAULT_ACTION"
          else
            echo "Default action was already Allow, no restore needed"
          fi

          echo "‚úÖ Storage Account public access settings restored"

      - name: Generate Test Job Summary
        if: always()
        run: |
          echo "## üß™ CosmosDB/Azure Search Setup Test Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Field | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| **Job Status** | ${{ job.status == 'success' && '‚úÖ Success' || '‚ùå Failed' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| **Azure Search Service** | \`${{ steps.extract_names.outputs.AZURE_SEARCH_SERVICE }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| **Azure Search Index** | \`${{ inputs.AZURE_SEARCH_INDEX }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| **Azure Blob Storage Account** | \`${{ steps.extract_names.outputs.AZURE_BLOB_ACCOUNT_NAME }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| **Resource Group** | \`${{ inputs.RESOURCE_GROUP_NAME }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| **WAF Mode** | \`${{ inputs.WAF }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [[ "${{ job.status }}" == "success" ]]; then
            echo "### ‚úÖ Test Results" >> $GITHUB_STEP_SUMMARY
            echo "- Document uploaded to blob storage to trigger index creation" >> $GITHUB_STEP_SUMMARY
            echo "- Azure Search index populated with test data" >> $GITHUB_STEP_SUMMARY
            if [[ "${{ inputs.WAF }}" == "true" ]]; then
              echo "- WAF mode: Public access enabled and then disabled after data import" >> $GITHUB_STEP_SUMMARY
            fi
          else
            echo "### ‚ùå Test Failed" >> $GITHUB_STEP_SUMMARY
            echo "- Check the job logs for detailed error information" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Logout from Azure
        if: always()
        shell: bash
        run: |
          az logout || true
          echo "Logged out from Azure."
