name: Populate Sample Data for CosmosDB

on:
  workflow_dispatch:
    inputs:
      RESOURCE_GROUP_NAME:
        description: 'Azure Resource Group name'
        required: true
        type: string
      AZURE_SEARCH_SERVICE:
        description: 'Azure Search service name or URL'
        required: true
        type: string
      AZURE_BLOB_ACCOUNT_NAME:
        description: 'Azure Blob Storage Account name'
        required: true
        type: string
      AZURE_SEARCH_INDEX:
        description: 'Azure Search index name'
        required: true
        type: string
      WAF:
        description: 'Enable WAF mode (enables public access and allows all IPs for Azure Search)'
        required: false
        type: boolean
        default: false
  workflow_call:
    inputs:
      RESOURCE_GROUP_NAME:
        description: 'Azure Resource Group name'
        required: true
        type: string
      AZURE_SEARCH_SERVICE:
        description: 'Azure Search service name or URL'
        required: true
        type: string
      AZURE_BLOB_ACCOUNT_NAME:
        description: 'Azure Blob Storage Account name'
        required: true
        type: string
      AZURE_SEARCH_INDEX:
        description: 'Azure Search index name'
        required: true
        type: string
      WAF:
        description: 'Enable WAF mode (enables public access and allows all IPs for Azure Search)'
        required: false
        type: boolean
        default: false

jobs:
  test-cosmosdb-setup:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install Python dependencies
        run: |
          pip install requests azure-storage-blob azure-identity

      - name: Login to Azure
        shell: bash
        run: |
          az login --service-principal -u ${{ secrets.AZURE_CLIENT_ID }} -p ${{ secrets.AZURE_CLIENT_SECRET }} --tenant ${{ secrets.AZURE_TENANT_ID }}
          az account set --subscription ${{ secrets.AZURE_SUBSCRIPTION_ID }}

      - name: Upgrade Azure CLI and install extensions
        run: |
          az upgrade --yes --all
          az extension add --name storage-preview --upgrade --yes || true

      - name: Extract Service Names
        id: extract_names
        run: |
          # Extract Azure Search service name if full URL is provided
          AZURE_SEARCH_SERVICE_INPUT="${{ inputs.AZURE_SEARCH_SERVICE }}"
          if [[ "$AZURE_SEARCH_SERVICE_INPUT" == https://* ]]; then
            AZURE_SEARCH_SERVICE=$(echo "$AZURE_SEARCH_SERVICE_INPUT" | sed 's|https://||' | cut -d'.' -f1)
          else
            AZURE_SEARCH_SERVICE="$AZURE_SEARCH_SERVICE_INPUT"
          fi
          echo "AZURE_SEARCH_SERVICE=$AZURE_SEARCH_SERVICE" >> $GITHUB_OUTPUT
          echo "Using Azure Search Service: $AZURE_SEARCH_SERVICE"

          # Extract Azure Blob Storage Account name if full URL is provided
          AZURE_BLOB_ACCOUNT_NAME_INPUT="${{ inputs.AZURE_BLOB_ACCOUNT_NAME }}"
          if [[ "$AZURE_BLOB_ACCOUNT_NAME_INPUT" == https://* ]]; then
            AZURE_BLOB_ACCOUNT_NAME=$(echo "$AZURE_BLOB_ACCOUNT_NAME_INPUT" | sed 's|https://||' | cut -d'.' -f1)
          else
            AZURE_BLOB_ACCOUNT_NAME="$AZURE_BLOB_ACCOUNT_NAME_INPUT"
          fi
          echo "AZURE_BLOB_ACCOUNT_NAME=$AZURE_BLOB_ACCOUNT_NAME" >> $GITHUB_OUTPUT
          echo "Using Azure Blob Storage Account: $AZURE_BLOB_ACCOUNT_NAME"

      - name: Enable Public Access for Azure Search and Storage Account (WAF)
        if: ${{ inputs.WAF == true }}
        run: |
          AZURE_SEARCH_SERVICE="${{ steps.extract_names.outputs.AZURE_SEARCH_SERVICE }}"
          AZURE_BLOB_ACCOUNT_NAME="${{ steps.extract_names.outputs.AZURE_BLOB_ACCOUNT_NAME }}"
          RESOURCE_GROUP="${{ inputs.RESOURCE_GROUP_NAME }}"
          SUBSCRIPTION_ID="${{ secrets.AZURE_SUBSCRIPTION_ID }}"

          echo "Enabled WAF - Configuring public access for resources"

          # ========== Enable Public Access for Azure Search ==========
          echo ""
          echo "üì¶ Configuring Azure Search service: $AZURE_SEARCH_SERVICE"

          # Get the current identity configuration to preserve it during update
          echo "Getting current identity configuration..."
          IDENTITY_TYPE=$(az search service show \
            --name "$AZURE_SEARCH_SERVICE" \
            --resource-group "$RESOURCE_GROUP" \
            --query "identity.type" -o tsv 2>/dev/null || echo "None")

          echo "Current identity type: $IDENTITY_TYPE"

          # Enable public network access for Azure Search with retry logic
          echo "Enabling public network access..."

          MAX_RETRIES=5
          RETRY_DELAY=30
          SEARCH_SUCCESS=false

          for attempt in $(seq 1 $MAX_RETRIES); do
            echo "Attempt $attempt of $MAX_RETRIES..."

            # Check if identity type contains UserAssigned (handles "UserAssigned", "SystemAssigned, UserAssigned", etc.)
            if [[ "$IDENTITY_TYPE" == *"UserAssigned"* ]]; then
              # Azure CLI doesn't support UserAssigned identity updates, use REST API instead
              echo "Using REST API to preserve UserAssigned identity configuration..."

              # Get the current service configuration to preserve identity
              CURRENT_CONFIG=$(az search service show \
                --name "$AZURE_SEARCH_SERVICE" \
                --resource-group "$RESOURCE_GROUP" \
                -o json)

              # Extract the identity block
              IDENTITY_BLOCK=$(echo "$CURRENT_CONFIG" | jq '.identity')

              # Build the PATCH request body with only the properties we want to update
              PATCH_BODY=$(jq -n \
                --argjson identity "$IDENTITY_BLOCK" \
                '{
                  "properties": {
                    "publicNetworkAccess": "enabled"
                  },
                  "identity": $identity
                }')

              echo "Sending PATCH request to update public access..."
              if az rest --method PATCH \
                --uri "https://management.azure.com/subscriptions/${SUBSCRIPTION_ID}/resourceGroups/${RESOURCE_GROUP}/providers/Microsoft.Search/searchServices/${AZURE_SEARCH_SERVICE}?api-version=2024-03-01-preview" \
                --body "$PATCH_BODY" 2>&1; then
                echo "‚úÖ Public access enabled for Azure Search service"
                SEARCH_SUCCESS=true
                break
              fi
            else
              if az search service update \
                --name "$AZURE_SEARCH_SERVICE" \
                --resource-group "$RESOURCE_GROUP" \
                --public-access enabled 2>&1; then
                echo "‚úÖ Public access enabled for Azure Search service"
                SEARCH_SUCCESS=true
                break
              fi
            fi

            if [ $attempt -lt $MAX_RETRIES ]; then
              echo "‚ö†Ô∏è Update failed, retrying in ${RETRY_DELAY} seconds..."
              sleep $RETRY_DELAY
              RETRY_DELAY=$((RETRY_DELAY * 2))
            fi
          done

          if [ "$SEARCH_SUCCESS" != "true" ]; then
            echo "‚ùå Failed to enable public access for Azure Search after $MAX_RETRIES attempts"
            exit 1
          fi

          # ========== Enable Public Access for Storage Account ==========
          echo ""
          echo "üì¶ Configuring Storage Account: $AZURE_BLOB_ACCOUNT_NAME"

          # Enable public network access
          echo "Enabling public network access..."
          az storage account update \
            --name "$AZURE_BLOB_ACCOUNT_NAME" \
            --resource-group "$RESOURCE_GROUP" \
            --public-network-access Enabled \
            --output none

          # Set default action to Allow
          echo "Setting default action to Allow..."
          az storage account update \
            --name "$AZURE_BLOB_ACCOUNT_NAME" \
            --resource-group "$RESOURCE_GROUP" \
            --default-action Allow \
            --output none

          echo "‚úÖ Public access enabled for Storage Account"
          echo ""
          echo "‚úÖ All resources configured for public access"

      - name: Upload Document to Blob Storage to Trigger Index Creation
        run: |
          AZURE_BLOB_ACCOUNT_NAME="${{ steps.extract_names.outputs.AZURE_BLOB_ACCOUNT_NAME }}"

          echo "Uploading sample document to blob storage to trigger index creation..."

          # Get storage account key for authentication
          STORAGE_KEY=$(az storage account keys list --account-name "$AZURE_BLOB_ACCOUNT_NAME" --resource-group "${{ inputs.RESOURCE_GROUP_NAME }}" --query '[0].value' -o tsv)

          # Upload file using Azure CLI with account key
          az storage blob upload \
            --account-name "$AZURE_BLOB_ACCOUNT_NAME" \
            --account-key "$STORAGE_KEY" \
            --container-name "documents" \
            --name "PerksPlus.pdf" \
            --file "data/PerksPlus.pdf" \
            --overwrite

          echo "‚úÖ Document uploaded to blob storage"

      - name: Wait for Index Creation
        run: |
          AZURE_SEARCH_SERVICE="${{ steps.extract_names.outputs.AZURE_SEARCH_SERVICE }}"
          AZURE_SEARCH_INDEX="${{ inputs.AZURE_SEARCH_INDEX }}"

          # Get Azure Search admin key
          AZURE_SEARCH_KEY=$(az search admin-key show --service-name $AZURE_SEARCH_SERVICE --resource-group ${{ inputs.RESOURCE_GROUP_NAME }} --query primaryKey -o tsv)

          echo "Waiting for index '$AZURE_SEARCH_INDEX' to be created by the application..."
          echo "This may take a few minutes as the document is processed..."

          # Wait up to 10 minutes for the index to be created
          for i in {1..20}; do
            echo "Checking for index (attempt $i/20)..."

            HTTP_STATUS=$(curl -s -o /dev/null -w "%{http_code}" \
              "https://${AZURE_SEARCH_SERVICE}.search.windows.net/indexes/${AZURE_SEARCH_INDEX}?api-version=2024-07-01" \
              -H "api-key: ${AZURE_SEARCH_KEY}")

            if [ "$HTTP_STATUS" == "200" ]; then
              echo "‚úÖ Index '$AZURE_SEARCH_INDEX' found!"
              break
            fi

            if [ $i -eq 20 ]; then
              echo "‚ö†Ô∏è Index not found after 10 minutes, proceeding anyway..."
            else
              echo "Index not found yet (HTTP $HTTP_STATUS), waiting 30 seconds..."
              sleep 30
            fi
          done

      - name: Populate Azure Search Index
        run: |
          AZURE_SEARCH_SERVICE="${{ steps.extract_names.outputs.AZURE_SEARCH_SERVICE }}"
          AZURE_SEARCH_INDEX="${{ inputs.AZURE_SEARCH_INDEX }}"

          export AZURE_SEARCH_SERVICE
          export AZURE_SEARCH_INDEX

          # Get Azure Search admin key from Azure
          export AZURE_SEARCH_KEY=$(az search admin-key show --service-name $AZURE_SEARCH_SERVICE --resource-group ${{ inputs.RESOURCE_GROUP_NAME }} --query primaryKey -o tsv)

          echo "Populating index: $AZURE_SEARCH_INDEX"

          python - <<EOF
          import requests
          import json
          import os

          # Azure Cognitive Search details from environment
          SEARCH_SERVICE = os.environ.get("AZURE_SEARCH_SERVICE")
          INDEX_NAME = os.environ.get("AZURE_SEARCH_INDEX")
          API_KEY = os.environ.get("AZURE_SEARCH_KEY")

          # Use stable API version
          API_VERSION = "2024-07-01"

          # Search API endpoint
          ENDPOINT = f"https://{SEARCH_SERVICE}.search.windows.net/indexes/{INDEX_NAME}/docs/index?api-version={API_VERSION}"
          HEADERS = {
              "Content-Type": "application/json",
              "api-key": API_KEY
          }

          # Load exported data
          with open("data/azure_search_data.json", "r", encoding="utf-8") as f:
              documents = json.load(f)

          # Format for Azure Search bulk upload
          payload = {
              "value": [{"@search.action": "upload", **doc} for doc in documents]
          }

          print(f"Uploading {len(documents)} documents to index '{INDEX_NAME}'...")

          # Send data to Azure Search
          response = requests.post(ENDPOINT, headers=HEADERS, json=payload)

          if response.status_code in [200, 207]:
              result = response.json()
              success_count = sum(1 for item in result.get('value', []) if item.get('status', False))
              print(f"‚úÖ Import completed! {success_count}/{len(documents)} documents uploaded successfully.")
          else:
              print(f"‚ùå Failed to import data: {response.status_code}, {response.text}")
              exit(1)
          EOF

      - name: Wait for Data Propagation
        run: |
          echo "Waiting for data propagation..."
          sleep 60
          echo "‚úÖ Wait complete."

      - name: Disable Public Access for Azure Search and Storage Account (WAF)
        if: ${{ inputs.WAF == true }}
        run: |
          AZURE_SEARCH_SERVICE="${{ steps.extract_names.outputs.AZURE_SEARCH_SERVICE }}"
          AZURE_BLOB_ACCOUNT_NAME="${{ steps.extract_names.outputs.AZURE_BLOB_ACCOUNT_NAME }}"
          RESOURCE_GROUP="${{ inputs.RESOURCE_GROUP_NAME }}"
          SUBSCRIPTION_ID="${{ secrets.AZURE_SUBSCRIPTION_ID }}"

          echo "Disabling public access for resources"

          # ========== Disable Public Access for Azure Search ==========
          echo ""
          echo "üì¶ Configuring Azure Search service: $AZURE_SEARCH_SERVICE"

          # Get the current identity configuration to preserve it during update
          echo "Getting current identity configuration..."
          IDENTITY_TYPE=$(az search service show \
            --name "$AZURE_SEARCH_SERVICE" \
            --resource-group "$RESOURCE_GROUP" \
            --query "identity.type" -o tsv 2>/dev/null || echo "None")

          echo "Current identity type: $IDENTITY_TYPE"

          # Disable public network access for Azure Search with retry logic
          echo "Disabling public network access..."

          MAX_RETRIES=5
          RETRY_DELAY=30
          SEARCH_SUCCESS=false

          for attempt in $(seq 1 $MAX_RETRIES); do
            echo "Attempt $attempt of $MAX_RETRIES..."

            # Check if identity type contains UserAssigned (handles "UserAssigned", "SystemAssigned, UserAssigned", etc.)
            if [[ "$IDENTITY_TYPE" == *"UserAssigned"* ]]; then
              # Azure CLI doesn't support UserAssigned identity updates, use REST API instead
              echo "Using REST API to preserve UserAssigned identity configuration..."

              # Get the current service configuration to preserve identity
              CURRENT_CONFIG=$(az search service show \
                --name "$AZURE_SEARCH_SERVICE" \
                --resource-group "$RESOURCE_GROUP" \
                -o json)

              # Extract the identity block
              IDENTITY_BLOCK=$(echo "$CURRENT_CONFIG" | jq '.identity')

              # Build the PATCH request body with only the properties we want to update
              PATCH_BODY=$(jq -n \
                --argjson identity "$IDENTITY_BLOCK" \
                '{
                  "properties": {
                    "publicNetworkAccess": "disabled"
                  },
                  "identity": $identity
                }')

              echo "Sending PATCH request to update public access..."
              if az rest --method PATCH \
                --uri "https://management.azure.com/subscriptions/${SUBSCRIPTION_ID}/resourceGroups/${RESOURCE_GROUP}/providers/Microsoft.Search/searchServices/${AZURE_SEARCH_SERVICE}?api-version=2024-03-01-preview" \
                --body "$PATCH_BODY" 2>&1; then
                echo "‚úÖ Public access disabled for Azure Search service"
                SEARCH_SUCCESS=true
                break
              fi
            else
              if az search service update \
                --name "$AZURE_SEARCH_SERVICE" \
                --resource-group "$RESOURCE_GROUP" \
                --public-access disabled 2>&1; then
                echo "‚úÖ Public access disabled for Azure Search service"
                SEARCH_SUCCESS=true
                break
              fi
            fi

            if [ $attempt -lt $MAX_RETRIES ]; then
              echo "‚ö†Ô∏è Update failed, retrying in ${RETRY_DELAY} seconds..."
              sleep $RETRY_DELAY
              RETRY_DELAY=$((RETRY_DELAY * 2))
            fi
          done

          if [ "$SEARCH_SUCCESS" != "true" ]; then
            echo "‚ùå Failed to disable public access for Azure Search after $MAX_RETRIES attempts"
            exit 1
          fi

          # ========== Disable Public Access for Storage Account ==========
          echo ""
          echo "üì¶ Configuring Storage Account: $AZURE_BLOB_ACCOUNT_NAME"

          # Disable public network access
          echo "Disabling public network access..."
          az storage account update \
            --name "$AZURE_BLOB_ACCOUNT_NAME" \
            --resource-group "$RESOURCE_GROUP" \
            --public-network-access Disabled \
            --output none

          # Set default action to Deny
          echo "Setting default action to Deny..."
          az storage account update \
            --name "$AZURE_BLOB_ACCOUNT_NAME" \
            --resource-group "$RESOURCE_GROUP" \
            --default-action Deny \
            --output none

          echo "‚úÖ Public access disabled for Storage Account"
          echo ""
          echo "‚úÖ All resources restored to secure state"

      - name: Generate Test Job Summary
        if: always()
        run: |
          echo "## üß™ CosmosDB/Azure Search Setup Test Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Field | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| **Job Status** | ${{ job.status == 'success' && '‚úÖ Success' || '‚ùå Failed' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| **Azure Search Service** | \`${{ steps.extract_names.outputs.AZURE_SEARCH_SERVICE }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| **Azure Search Index** | \`${{ inputs.AZURE_SEARCH_INDEX }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| **Azure Blob Storage Account** | \`${{ steps.extract_names.outputs.AZURE_BLOB_ACCOUNT_NAME }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| **Resource Group** | \`${{ inputs.RESOURCE_GROUP_NAME }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| **WAF** | \`${{ inputs.WAF }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [[ "${{ job.status }}" == "success" ]]; then
            echo "### ‚úÖ Test Results" >> $GITHUB_STEP_SUMMARY
            echo "- Document uploaded to blob storage to trigger index creation" >> $GITHUB_STEP_SUMMARY
            echo "- Azure Search index populated with test data" >> $GITHUB_STEP_SUMMARY
            if [[ "${{ inputs.WAF }}" == "true" ]]; then
              echo "- WAF: Public access enabled and then disabled after data import" >> $GITHUB_STEP_SUMMARY
            fi
          else
            echo "### ‚ùå Test Failed" >> $GITHUB_STEP_SUMMARY
            echo "- Check the job logs for detailed error information" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Logout from Azure
        if: always()
        shell: bash
        run: |
          az logout || true
          echo "Logged out from Azure."
