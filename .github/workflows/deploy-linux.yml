name: Deploy-Test-Cleanup (v2) Linux
on:
  push:
    branches:
      - import-data-fixed
  workflow_dispatch:
    inputs:
      resource_group_name:
        description: 'Resource Group Name'
        required: true
        type: string

      DATABASE_TYPE:
        description: 'Database Type'
        required: false
        type: choice
        options:
          - 'PostgreSQL'
          - 'CosmosDB'
        default: 'PostgreSQL'

      waf_enabled:
        description: 'Enable WAF'
        required: false
        default: false
        type: boolean
      EXP:
        description: 'Enable EXP'
        required: false
        default: false
        type: boolean

      cleanup_resources:
        description: 'Cleanup Deployed Resources'
        required: false
        default: false
        type: boolean
      run_e2e_tests:
        description: 'Run End-to-End Tests'
        required: false
        default: 'GoldenPath-Testing'
        type: choice
        options:
          - 'GoldenPath-Testing'
          - 'Smoke-Testing'
          - 'None'
      AZURE_ENV_LOG_ANALYTICS_WORKSPACE_ID:
        description: 'Log Analytics Workspace ID (Optional)'
        required: false
        default: ''
        type: string
      AZURE_SEARCH_USE_INTEGRATED_VECTORIZATION:
        description: 'Azure Search Integrated Vectorization'
        required: false
        type: choice
        options:
          - 'false'
          - 'true'
        default: 'false'
      AZURE_SEARCH_USE_SEMANTIC_SEARCH:
        description: 'Azure Search Semantic Search'
        required: false
        type: choice
        options:
          - 'false'
          - 'true'
        default: 'false'

      existing_webapp_url:
        description: 'Existing FrontEndWeb URL (Skips Deployment)'
        required: false
        default: ''
        type: string

      existing_admin_app_url:
        description: 'Existing AdminWeb URL (Skips Deployment)'
        required: false
        default: ''
        type: string

  schedule:
    - cron: '0 9,21 * * *'  # Runs at 9:00 AM and 9:00 PM GMT

concurrency:
  group: ${{ github.event_name == 'workflow_dispatch' && format('manual-{0}', github.run_id) || 'deploy-auto-triggered' }}
  cancel-in-progress: false

jobs:
  Run:
    uses: ./.github/workflows/deploy-orchestrator.yml
    with:
      runner_os: ubuntu-latest
      resource_group_name: ${{ github.event_name == 'workflow_dispatch' && github.event.inputs.resource_group_name || 'rg-cwyd-ci' }}
      waf_enabled: ${{ github.event.inputs.waf_enabled == 'true' }}
      EXP: ${{ github.event.inputs.EXP == 'true' }}
      cleanup_resources: ${{ github.event_name != 'workflow_dispatch' || github.event.inputs.cleanup_resources == 'true' }}
      run_e2e_tests: ${{ github.event.inputs.run_e2e_tests || 'GoldenPath-Testing' }}
      AZURE_ENV_LOG_ANALYTICS_WORKSPACE_ID: ${{ github.event.inputs.AZURE_ENV_LOG_ANALYTICS_WORKSPACE_ID || '' }}
      existing_webapp_url: ${{ github.event.inputs.existing_webapp_url || '' }}
      existing_admin_app_url: ${{ github.event.inputs.existing_admin_app_url || '' }}
      trigger_type: ${{ github.event_name }}
      AZURE_SEARCH_USE_INTEGRATED_VECTORIZATION: ${{ github.event.inputs.AZURE_SEARCH_USE_INTEGRATED_VECTORIZATION || 'false' }}
      AZURE_SEARCH_USE_SEMANTIC_SEARCH: ${{ github.event.inputs.AZURE_SEARCH_USE_SEMANTIC_SEARCH || 'false' }}
      DATABASE_TYPE: ${{ github.event.inputs.DATABASE_TYPE || 'PostgreSQL' }}
    secrets: inherit
